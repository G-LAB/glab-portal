/*! G LAB Portal
* http://glabstudios.com/
* Copyright (c) 2012 GLAB
* All rights reserved. */
var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-18252433-3"]),_gaq.push(["_trackPageview"]),function(){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}();var GLAB={};GLAB.cookie=new Helper.cookie;var siteURL=decodeURIComponent(GLAB.cookie.get("ci_siteurl"))+"/",ciSessionexpire,loadingCount=0,mapModalMap,mapDirectionsService,mapDirectionsRenderer,mapDirectionsMap,Portal=function(){};Portal.prototype.gmapBind=function(){jQuery(".map").each(function(){var a,b,c=jQuery(this),d=new google.maps.Geocoder,e=new google.maps.Map(this,{zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP});if(c.data("latlng")!==undefined){var f=c.data("latlng").split(",",2);a=f[0],b=f[1],e.setCenter(new google.maps.LatLng(a,b))}else c.data("address")!==undefined&&d.geocode({address:c.data("address")},function(a,b){if(b===google.maps.GeocoderStatus.OK){e.setCenter(a[0].geometry.location);var c=new google.maps.Marker({map:e,position:a[0].geometry.location})}})})},Portal.prototype.gmapInit=function(){mapModalMap=new google.maps.Map(document.getElementById("modal_map_gmap"),{zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP}),mapDirectionsService=new google.maps.DirectionsService,mapDirectionsRenderer=new google.maps.DirectionsRenderer,mapDirectionsMap=new google.maps.Map(document.getElementById("modal_directions_gmap"),{zoom:9,center:new google.maps.LatLng(34.05,-118.24),mapTypeId:google.maps.MapTypeId.ROADMAP}),mapDirectionsRenderer.setMap(mapDirectionsMap),mapDirectionsRenderer.setPanel(document.getElementById("modal_directions_list")),this.gmapBind()},Portal.prototype.overlay=function(a){var b=jQuery("#overlay_loading");a==="show"||a===!0?(jQuery("#overlay_loading_progress").css({width:"100%"}),jQuery("#overlay_loading_text").text("  "),b.fadeIn("slow")):(a==="hide"||a===!1)&&b.fadeOut("fast")},Portal.prototype.loading=function(a){var b=jQuery("#loading_bar"),c=[];c.push("Reticulating Splines"),c.push("Go ahead, hold your breath!"),c.push("Hampsters Processing"),c.push("Inverting Multipliers"),c.push("Please Don't Feed the Programmers"),c.push("Pretending To Do Something Useful"),c.push("Foraging For Objects"),c.push("Sarcasm Approaching Critical Levels"),c.push("Does anyone read these things?"),c.push("Hitting Your Keyboard Won't Make This Faster"),c.push("Ensuring Everything Works Perfectly"),c.push("Spawning Zombie Processes"),c.push("Loading Cute Cat Photos"),c.push("Can Haz JSON???"),c.push("Alright, Which Jokester Stored the Data on a Floppy?"),a==="show"||a===!0?loadingCount++:(a==="hide"||a===!1)&&loadingCount--;if(loadingCount>0){var d=Math.floor(Math.random()*c.length);jQuery("#loading_bar_text").text(c[d]),b.fadeIn("fast")}else b.fadeOut(1e3)},Portal.prototype.api=function(a,b,c,d){return jQuery.ajax({type:a,url:siteURL+"/ajax/"+b,data:c,dataType:"json",complete:d})},Portal=new Portal,jQuery(".input-prepend input").on("focus",function(){jQuery(this).parent().find('.add-on input[type="radio"]').click()}),jQuery(window).unload(function(){Portal.overlay("show")}),window.onbeforeunload=function(){Portal.overlay("show")};var assets=["//maps.googleapis.com/maps/api/js?key=AIzaSyAgsnPACf66og7cXNk48Toh6ijmogR3H7E&callback=Portal.gmapInit&sensor=false&v=3.7","/assets/js/dist/plugins.min.js"];Modernizr.load([{load:assets,callback:function(a,b,c){jQuery("#overlay_loading_progress").css({width:c/assets.length*100+"%"}),jQuery("#overlay_loading_text").text("Initialized "+a)},complete:function(){jQuery.holdReady(!1),Portal.overlay("hide"),jQuery(".dropdown-toggle").dropdown(),jQuery(".alert-message").alert(),jQuery(".tabbable").tab(),jQuery("a[title], i[title], span[title]").tooltip(),window.alert=bootbox.alert,window.confirm=bootbox.confirm,jQuery('[data-action="modal-map"]').on("click",function(a){a.preventDefault();var b=jQuery(this),c=jQuery("#modal_map"),d=new google.maps.Geocoder,e;b.data("address")!==undefined&&b.data("address").substring(0,1)==="#"?jQuery(b.data("address")).data("address")!==undefined?e=jQuery(b.data("address")).data("address"):e=jQuery(b.data("address")).text():e=b.data("address"),d.geocode({address:e},function(a,b){if(b===google.maps.GeocoderStatus.OK){mapModalMap.setCenter(a[0].geometry.location);var c=new google.maps.Marker({map:mapModalMap,position:a[0].geometry.location})}else window.alert("Geocode was not successful for the following reason: "+b)}),c.find("h3").text(e),c.modal("show")}),jQuery('[data-action="modal-directions"]').on("click",function(a){a.preventDefault();var b=jQuery(this),c=jQuery("#modal_directions"),d;b.data("address")!==undefined&&b.data("address").substring(0,1)==="#"?jQuery(b.data("address")).data("address")!==undefined?d=jQuery(b.data("address")).data("address"):d=jQuery(b.data("address")).text():d=b.data("address"),c.find("#modal_directions_form").show(),c.find("#modal_directions_list").hide().empty(),mapDirectionsMap.setZoom(9),c.find("#destination").val(d),c.modal("show").css({width:"100%","max-width":"650px","margin-left":function(){return-(jQuery(this).width()/2)}})}),jQuery("#modal_directions_submit").on("click",function(a){a.preventDefault();var b=jQuery("#modal_directions"),c=b.find("#origin").val(),d=b.find("#destination").val();mapDirectionsService.route({origin:c,destination:d,travelMode:google.maps.TravelMode.DRIVING},function(a,c){c===google.maps.DirectionsStatus.OK&&b.find("#modal_directions_form").fadeOut("fast",function(){mapDirectionsRenderer.setDirections(a),b.find("#modal_directions_list").empty().fadeIn("slow")})})}),jQuery("#modal_map").on("shown",function(){google.maps.event.trigger(mapModalMap,"resize")}),jQuery("#modal_directions").on("shown",function(){google.maps.event.trigger(mapDirectionsMap,"resize")})}}]),jQuery(document).ready(function(){jQuery(document).ajaxStart(function(){Portal.loading(!0)}),jQuery(document).ajaxStop(function(){Portal.loading(!1)})});if(jQuery("body").attr("id")==="default"){ciSessionexpire=GLAB.cookie.get("ci_sessionexpire")*1e3;var timeoutTrigger=ciSessionexpire-9e4;timeoutTrigger>0&&(setInterval(function(){jQuery("#modal_timeout").modal("show")},timeoutTrigger),jQuery("#modal_timeout").on("shown",function(){var a=60;jQuery("#modal_timeout .counter").text(a),window.timeoutCounter=setInterval(function(){jQuery("#modal_timeout .counter").text(a),a>0&&(a=a-1)},1e3),window.timeoutSession=setTimeout(function(){window.location=siteURL+"/login/destroy?timeout=1&location="},6e4)}),jQuery("#modal_timeout").on("hide",function(){jQuery.ajax(siteURL+"/login/heartbeat"),clearTimeout(window.timeoutSession),clearInterval(window.timeoutCounter)})),jQuery("#btn_app_install").on("click",function(a){a.preventDefault(),window.chrome.webstore.install("",function(){},function(a){window.alert(a)})})}jQuery("body").hasClass("chrome")&&window.chrome===undefined&&jQuery("#btn_app_install").addClass("disabled");if(jQuery("body").hasClass("client_profile"))jQuery('#email [data-action="email-remove"]').on("click",function(){var a=jQuery(this);bootbox.dialog("Are you sure that you want to remove this email address?",[{label:"Cancel"},{label:"Remove","class":"btn-danger",callback:function(){a.closest("li").remove()}}])}),jQuery('#telephone [data-action="tel-remove"]').on("click",function(){var a=jQuery(this);bootbox.dialog("Are you sure that you want to remove this telephone number?",[{label:"Cancel"},{label:"Remove","class":"btn-danger",callback:function(){a.closest("li").remove()}}])}),jQuery('#address [data-action="address-remove"]').on("click",function(){var a=jQuery(this);bootbox.dialog("Are you sure that you want to remove this address?",[{label:"Cancel"},{label:"Remove","class":"btn-danger",callback:function(){jQuery("#address .active").remove(),jQuery("#address .help-block").addClass("active")}}])}),jQuery('#manager button[data-action="manager-revoke"]').on("click",function(){var a=jQuery(this);bootbox.dialog("Are you sure that you want to revoke access?",[{label:"Cancel"},{label:"Revoke","class":"btn-danger",callback:function(){a.closest("tr").remove()}}])}),jQuery(document).ready(function(){Portal.api("get","/proxy/communication/email_list/groups").success(function(a){var b={};b.pid=jQuery(".vcard .fn").data("pid"),Portal.api("get","/proxy/communication/email_list/subscriber",b).success(function(b){var c={};jQuery.each(b.merges.GROUPINGS,function(a,b){c[b.id]=b.groups.split(", ")});var d=jQuery("#email_subscriptions table tbody");d.empty(),jQuery.each(a,function(a,b){jQuery.each(b.groups,function(a,d){c[b.id].indexOf(d.name)>-1?d.checked=!0:d.checked=!1});var e=ich.email_subscriptions_row(b);d.append(e)}),jQuery("#email_subscriptions form").change(function(a){var b=jQuery(this),c=b.serialize();b.find("input").attr("disabled","disabled"),Portal.api("post","/proxy/communication/email_list/subscriber",c,function(){b.find("input").removeAttr("disabled")})})})}).error(function(){window.alert("Error retrieving interest groups from MailChimp.")})});else if(jQuery("body").hasClass("dashboard")){if(Boolean(GLAB.cookie.get("dashboard_welcome_hide"))!==!0){var welcome=jQuery("#welcome"),hud=jQuery("#hud");welcome.show(),hud.hide(),jQuery(welcome).on("click","a.btn",function(){jQuery("#welcome_hide").is(":checked")&&GLAB.cookie.set("dashboard_welcome_hide","1")}),jQuery("#btn_welcome_hide").on("click",function(){welcome.fadeOut("slow",function(){hud.fadeIn("slow")})})}window.chrome!==undefined&&window.chrome.app.isInstalled!==!0&&jQuery("#alert_chrome").show();var inboxLoadCount=0;function inboxLoading(a){a===!0?(inboxLoadCount++,jQuery("#btn_inbox_refresh").addClass("active")):--inboxLoadCount<=0&&(jQuery("#btn_inbox_refresh").removeClass("active"),inboxLoadCount=0)}function inboxRefresh(){var a=5,b=jQuery("#inbox .message").first().data("unique-id");b===undefined&&(b=""),inboxLoading(!0),jQuery.getJSON(siteURL+"/dashboard/inbox_feed/"+a+"/"+b,function(b){jQuery.each(b.messages.reverse(),function(a,b){var c=ich.inbox_row(b);jQuery("#inbox tbody").prepend(c)}),jQuery("#inbox .message").each(function(b,c){b+1>a&&jQuery(this).remove()});var c=jQuery("#message_count");c.find(".shown").text(jQuery("#inbox tbody tr input").size()),c.find(".total").text(b.count_total)}).complete(function(){inboxLoading(!1)})}function inboxMessagesAction(a){var b=jQuery("#inbox tbody tr input:checked");b.size()>0?(inboxLoading(!0),b.each(function(b,c){var d=jQuery(c).closest("tr"),e=d.data("unique-id");jQuery.get(siteURL+"/dashboard/inbox_action/"+e+"/"+a).success(function(){d.remove(),inboxRefresh()}).error(function(){window.alert("Could not remove message"+e)}).complete(function(){inboxLoading(!1)})})):window.alert("You must select at least one message to continue.")}jQuery('#inbox a[data-action="inbox-archive"]').on("click",function(){inboxMessagesAction("archive")}),jQuery('#inbox a[data-action="inbox-spam"]').on("click",function(){bootbox.confirm("Are you sure that these messages are spam?",function(a){a&&inboxMessagesAction("spam")})}),jQuery('#inbox a[data-action="inbox-trash"]').on("click",function(){bootbox.confirm("Are you sure that you want to permanently remove these messages?",function(a){a&&inboxMessagesAction("trash")})}),jQuery('#inbox i[data-action="inbox-refresh"]').on("click",function(){inboxRefresh()}),jQuery(document).ready(function(){inboxRefresh(),setInterval(function(){inboxRefresh()},12e4)})}else jQuery("body").hasClass("preferences")&&jQuery("#device_request a.btn").on("click",function(){var a=jQuery(this);a.addClass("disabled"),jQuery("#device_loading").fadeIn(),jQuery.getJSON(siteURL+"/failure").success(function(b){a.fadeOut().hide(),jQuery("#device_loading").fadeOut().hide(),jQuery("#device_response").slideDown()}).error(function(){window.alert("Could not retrieve authorization code due to an unknown error.  Please try again later."),a.removeClass("disabled"),jQuery("#device_loading").fadeOut()})});